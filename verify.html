<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Email Verification | Servana</title>
  <style>
    body {
      font-family: 'Poppins', sans-serif; 
      margin: 0;
      padding: 0;
      background: linear-gradient(to bottom right, #030a5e, #0c0479);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      height: 100vh;
      text-align: center;
    }

    h2 {
      color: #fff;
    }

    #resend-button {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    #resend-button:hover {
      background-color: #0056b3;
    }

    #resend-status {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #ffcc00;
    }

    .hidden {
      display: none;
    }

    lottie-player {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <!-- ‚úÖ Lottie Animation -->
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <lottie-player
    src="https://assets10.lottiefiles.com/packages/lf20_jbrw3hcz.json"
    background="transparent"
    speed="1"
    style="width: 200px; height: 200px;"
    autoplay
  ></lottie-player>

  <h2>Verify Your Email</h2>
  <p>Please check your inbox. Redirecting after verification...</p>

  <!-- üîä Sound Effect -->
  <audio id="success-audio">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" type="audio/mpeg" />
  </audio>

  <button id="resend-button" class="hidden">Resend Verification Email</button>
  <div id="resend-status"></div>

  <!-- üîÅ Firebase & Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBo0wT2U4eEbD8uciW9ZBhKN2gDH_846j8",
      authDomain: "servana-59172.firebaseapp.com",
      projectId: "servana-59172",
      storageBucket: "servana-59172.appspot.com",
      messagingSenderId: "371435102114",
      appId: "1:371435102114:web:42d04c1584d55b29b09cfb"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const resendBtn = document.getElementById("resend-button");
    const statusDiv = document.getElementById("resend-status");
    const audio = document.getElementById("success-audio");

    // Auth state listener
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Show resend button after 10s if still unverified
        setTimeout(() => {
          if (!user.emailVerified) {
            resendBtn.classList.remove("hidden");
          }
        }, 10000);

        // Poll every 2 seconds
        const interval = setInterval(async () => {
          await user.reload();
          if (user.emailVerified) {
            clearInterval(interval);
            audio.play();
            statusDiv.textContent = "‚úÖ Email verified! Redirecting...";

            // Get role from Firestore
            const userDoc = await getDoc(doc(db, "users", user.uid));
            const role = userDoc.exists() ? userDoc.data().role : "seeker";

            // Redirect based on role
            if (role === "provider") {
              window.location.href = "/provider-dashboard.html";
            } else {
              window.location.href = "dashboard/dashboard.html";
            }
          }
        }, 2000);
      } else {
        window.location.href = "login.html";
      }
    });

    // Resend email
    resendBtn.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (user) {
        try {
          await sendEmailVerification(user);
          statusDiv.textContent = "üì© Verification email resent. Check your inbox!";
        } catch (err) {
          statusDiv.textContent = "‚ùå Error: " + err.message;
        }
      }
    });
  </script>
</body>
</html>
